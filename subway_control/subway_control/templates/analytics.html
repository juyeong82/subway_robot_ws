<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>êµ¬ê¸‰í™œë™ì¼ì§€ ë° ë¶„ì„</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #e9ecef; font-family: 'Noto Sans KR', sans-serif; }
        .report-paper { background: white; width: 210mm; min-height: 297mm; margin: 30px auto; padding: 40px; box-shadow: 0 0 20px rgba(0,0,0,0.1); border: 1px solid #d3d3d3; }
        .report-header { text-align: center; border-bottom: 3px double #333; padding-bottom: 15px; margin-bottom: 25px; }
        .report-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .report-table th, .report-table td { border: 1px solid #444; padding: 8px 12px; vertical-align: middle; font-size: 0.9rem; }
        .report-table th { background-color: #f8f9fa; width: 140px; text-align: center; font-weight: 700; color: #333; }
        .section-title { font-size: 1.1rem; font-weight: 800; margin-top: 25px; margin-bottom: 10px; border-left: 5px solid #2c3e50; padding-left: 10px; text-transform: uppercase; }
        .input-clean { width: 100%; border: 1px dashed #ccc; padding: 5px; font-family: inherit; font-weight: 500; background: #fdfdfd; }
        .input-clean:focus { border: 1px solid #0056b3; outline: none; background: #fff; }
        .gender-group label { cursor: pointer; padding: 4px 10px; border: 1px solid #ccc; border-radius: 4px; margin-right: 5px; font-size: 0.85rem; }
        .gender-group input[type="radio"] { display: none; }
        .gender-group input[type="radio"]:checked + label { background-color: #495057; color: white; }
        .timestamp-val { font-family: 'Consolas', monospace; color: #0056b3; font-weight: bold; }
        .status-badge { font-weight: bold; font-size: 0.85rem; }
        .status-pending { color: #adb5bd; }
        .status-done { color: #198754; }
        .notes-area { width: 100%; min-height: 200px; border: 1px solid #444; padding: 15px; font-size: 0.95rem; line-height: 1.6; background-color: #fff; white-space: pre-wrap; outline: none; }
        
        @media print {
            @page { margin: 15mm; size: A4; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .container { display: none !important; } 
            .report-paper { box-shadow: none; border: none; margin: 0; width: 100%; }
            .input-clean { border: none; padding: 0; }
            .gender-group input[type="radio"]:checked + label { background: none; color: black; font-weight: bold; text-decoration: underline; }
        }
    </style>
</head>
<body>

<div class="container text-center mt-4 no-print">
    <a href="/dashboard" class="btn btn-secondary me-2">ğŸ“º ì‹¤ì‹œê°„ ê´€ì œ</a>
    <a href="/history" class="btn btn-outline-secondary me-2">ğŸ“‹ ì´ë ¥ ëª©ë¡</a>
    <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ ë¦¬í¬íŠ¸ ì¶œë ¥</button>
</div>

<div class="report-paper">
    <div class="report-header">
        <h1 style="font-weight: 900; letter-spacing: -1px; font-size: 2rem;">êµ¬ê¸‰ í™œë™ ë° ë¶„ì„ ë³´ê³ ì„œ</h1>
        <p style="margin-top: 5px; font-size: 0.9rem; color: #555;">ë¬¸ì„œë²ˆí˜¸: ROKEY-2025-EMR-001 &nbsp;|&nbsp; ê´€ì œì†Œ: ì§€í•˜ì²  ì•ˆì „ í†µí•© ì„¼í„°</p>
    </div>

    <div class="section-title">1. í™˜ì ì¸ì ì‚¬í•­ (Patient Information)</div>
    <table class="report-table">
        <tr>
            <th>ì„± ëª… (Name)</th>
            <td><input type="text" id="input-name" class="input-clean"></td>
            <th>ì„± ë³„ (Gender)</th>
            <td>
                <div class="gender-group">
                    <input type="radio" name="gender" id="male" value="M"><label for="male">ë‚¨ì„±</label>
                    <input type="radio" name="gender" id="female" value="F"><label for="female">ì—¬ì„±</label>
                </div>
            </td>
        </tr>
        <tr>
            <th>ì—° ë ¹ (Age)</th>
            <td><input type="text" id="input-age" class="input-clean"></td>
            <th>ë°œìƒ ì¥ì†Œ</th>
            <td><input type="text" id="input-location" class="input-clean"></td>
        </tr>
        <tr>
            <th>í™˜ì ìƒíƒœ</th>
            <td colspan="3"><input type="text" id="input-status" class="input-clean text-danger" style="font-weight: 700;"></td>
        </tr>
    </table>

    <div class="section-title">2. ëŒ€ì‘ íƒ€ì„ë¼ì¸ (Response Timeline)</div>
    <table class="report-table">
        <thead>
            <tr style="background:#f8f9fa;">
                <th style="width:20%">êµ¬ ë¶„</th>
                <th style="width:25%">ì§„í–‰ ìƒíƒœ</th>
                <th>ë°œìƒ ì‹œê° (Time Log)</th>
            </tr>
        </thead>
        <tbody>
            <tr><th>ìƒí™© ì ‘ìˆ˜</th><td id="s-1" class="status-badge status-pending">ëŒ€ê¸°</td><td id="t-1" class="timestamp-val">-</td></tr>
            <tr><th>ì´ˆë™ ì¡°ì¹˜</th><td id="s-2" class="status-badge status-pending">ëŒ€ê¸°</td><td id="t-2" class="timestamp-val">-</td></tr>
            <tr><th>í™˜ì í†µì œ</th><td id="s-3" class="status-badge status-pending">ëŒ€ê¸°</td><td id="t-3" class="timestamp-val">-</td></tr>
            <tr><th>êµ¬ê¸‰ëŒ€ ì¸ê³„</th><td id="s-4" class="status-badge status-pending">ëŒ€ê¸°</td><td id="t-4" class="timestamp-val">-</td></tr>
            <tr><th>ìƒí™© ì¢…ë£Œ</th><td id="s-5" class="status-badge status-pending">ëŒ€ê¸°</td><td id="t-5" class="timestamp-val">-</td></tr>
        </tbody>
    </table>

    <div class="section-title">3. ì¡°ì¹˜ ë° íŠ¹ì´ì‚¬í•­ (Actions & Remarks)</div>
    <div id="input-remarks" class="notes-area" contenteditable="true"></div>

    <div class="mt-5 text-end">
        <p>ì‘ì„±ì¼ì‹œ: <span id="print-date"></span></p>
        <h5 style="margin-top: 20px; font-weight: 900;">ì§€í•˜ì²  ì•ˆì „ í†µí•© ê´€ì œì„¼í„°ì¥ (ì¸)</h5>
    </div>
</div>

<script>
    const now = new Date();
    document.getElementById('print-date').innerText = now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,'0') + "-" + String(now.getDate()).padStart(2,'0');

    loadData();

    function loadData() {
        fetch('/api/analytics/data' + window.location.search)
            .then(res => res.json())
            .then(data => {
                updateTimeline(data.logs);
                
                if (data.patient) {
                    const p = data.patient;
                    document.getElementById('input-name').value = p.name || "ì‹ ì› ë¯¸ìƒ (Unidentified)";
                    document.getElementById('input-age').value = p.age || "ë¯¸ìƒ (Unknown)";
                    document.getElementById('input-location').value = p.location || "í˜„ì¥ ìœ„ì¹˜ í™•ì¸ í•„ìš”";
                    document.getElementById('input-status').value = p.status || "ì´ˆê¸° ìƒíƒœ í‰ê°€ ëŒ€ê¸°";
                    document.getElementById('input-remarks').innerText = p.remarks || "íŠ¹ì´ì‚¬í•­ ì—†ìŒ.";
                    if (p.gender === 'M') document.getElementById('male').checked = true;
                    if (p.gender === 'F') document.getElementById('female').checked = true;
                }
            });
    }

    // [ìˆ˜ì •ëœ í•µì‹¬ í•¨ìˆ˜] ë¶ˆí•„ìš”í•œ í•„í„°ë§ ì œê±°í•˜ê³  ëª¨ë“  ë¡œê·¸ ìŠ¤ìº”
    function updateTimeline(logs) {
        if (!logs || logs.length === 0) return;

        // ì‹œê°„ ì˜¤ë¦„ì°¨ìˆœ (ê³¼ê±° -> í˜„ì¬) ì •ë ¬
        let sortedLogs = [...logs].sort((a, b) => a[2].localeCompare(b[2])); 

        // í‚¤ì›Œë“œ ì •ì˜ (sysmon.htmlê³¼ ë™ì¼í•˜ê²Œ í­ë„“ê²Œ ì„¤ì •)
        const steps = [
            { id: 1, key: ["ëŒ€ê¸°", "ì ‘ìˆ˜", "ì•Œë¦¼", "í˜¸ì¶œ", "ì‹œì‘", "ìˆ˜ì‹ "], label: "ì ‘ìˆ˜ ì™„ë£Œ" },
            { id: 2, key: ["AED", "ì¶œë™", "ì´ë™", "í™˜ì", "ê°€ëŠ” ì¤‘"], label: "ì¶œë™ ì™„ë£Œ" },
            { id: 3, key: ["í†µì œ", "ë°œê²¬", "ì•ˆë‚´", "ì•ˆì „", "ë„ì°©"], label: "í†µì œ ì‹¤ì‹œ" },
            { id: 4, key: ["êµ¬ê¸‰ëŒ€", "ì¸ê³„", "119"], label: "ì¸ê³„ ì™„ë£Œ" },
            { id: 5, key: ["ë³µê·€", "ì¢…ë£Œ", "ë„í‚¹"], label: "ìƒí™© ì¢…ë£Œ" }
        ];

        steps.forEach(step => {
            const timeCell = document.getElementById(`t-${step.id}`);
            const statusCell = document.getElementById(`s-${step.id}`);
            
            // í•´ë‹¹ ë‹¨ê³„ì˜ í‚¤ì›Œë“œê°€ í¬í•¨ëœ ë¡œê·¸ ì¤‘ 'ê°€ì¥ ë§ˆì§€ë§‰(ìµœì‹ )' ë¡œê·¸ë¥¼ ì°¾ìŒ
            let foundLog = null;
            for(let log of sortedLogs) {
                let msg = log[1]; 
                if (step.key.some(k => msg.includes(k))) {
                    foundLog = log;
                    // ì—¬ê¸°ì„œ breakí•˜ì§€ ì•Šê³  ê³„ì† ëŒë¦¬ë©´ ê°€ì¥ ë§ˆì§€ë§‰(ìµœì‹ ) ì‹œê°„ì„ ì¡ìŠµë‹ˆë‹¤.
                    // íƒ€ì„ë¼ì¸ì€ í•´ë‹¹ ë‹¨ê³„ê°€ 'ì™„ë£Œ'ëœ ì‹œì ì„ ì°ìœ¼ë¯€ë¡œ ì²« ë°œê²¬ì´ ë§ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    break; 
                }
            }

            if (foundLog) {
                let timeStr = foundLog[2].split('.')[0]; // ë°€ë¦¬ì´ˆ ì œê±°
                timeCell.innerText = timeStr;
                statusCell.innerText = step.label; 
                statusCell.className = "status-badge status-done"; 
                statusCell.style.color = "#198754";
            }
        });
    }

    function savePatientData() {
        const urlParams = new URLSearchParams(window.location.search);
        const reportId = urlParams.get('id');
        const payload = {
            id: reportId,
            name: document.getElementById('input-name').value,
            gender: document.querySelector('input[name="gender"]:checked')?.value,
            age: document.getElementById('input-age').value,
            location: document.getElementById('input-location').value,
            status: document.getElementById('input-status').value,
            remarks: document.getElementById('input-remarks').innerText
        };
        fetch('/api/analytics/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
    }

    document.querySelectorAll('.input-clean, .notes-area').forEach(el => el.addEventListener('blur', savePatientData));
    document.querySelectorAll('input[name="gender"]').forEach(el => el.addEventListener('change', savePatientData));
</script>

</body>
</html>