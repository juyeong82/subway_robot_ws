<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Subway Safety Control Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* === ì „ì²´ ë ˆì´ì•„ì›ƒ (í™”ë©´ ê½‰ ì±„ì›€ & ì „ì²´ ìŠ¤í¬ë¡¤ ë°©ì§€) === */
        html, body {
            height: 100%;
            margin: 0;
            background-color: #050505; /* Deep Black */
            color: #e0e0e0;
            font-family: 'Noto Sans KR', sans-serif; 
            overflow: hidden; /* [ì¤‘ìš”] ë¸Œë¼ìš°ì € ì „ì²´ ìŠ¤í¬ë¡¤ ì œê±° */
            user-select: none;
            display: flex;
            flex-direction: column;
        }

        /* 1. ìƒë‹¨ í—¤ë” */
        .header-bar { 
            height: 65px; 
            background-color: #111; 
            border-bottom: 1px solid #333; 
            padding: 0 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-shrink: 0;
            z-index: 10;
        }
        .system-title { font-size: 1.4rem; font-weight: 800; color: #fff; letter-spacing: -0.5px; }
        .status-indicator { font-size: 0.8rem; color: #00ff00; font-weight: bold; margin-left: 15px; text-transform: uppercase; letter-spacing: 1px; }

        /* 2. ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container-fluid.main-layout {
            flex: 1; 
            display: flex;
            flex-direction: column;
            padding: 20px; 
            gap: 20px; 
            min-height: 0; 
        }

        /* 3. ìƒë‹¨: ì¹´ë©”ë¼ ì˜ì—­ */
        .row-cams {
            flex: 0 0 auto; 
            display: flex;
            gap: 20px;
            margin: 0;
        }
        .col-cam {
            flex: 1;
            padding: 0;
        }

        /* 4. í•˜ë‹¨: ì •ë³´ ì˜ì—­ (ë‚¨ì€ ê³µê°„ ê½‰ ì±„ì›€) */
        .row-info {
            flex: 1; 
            display: flex;
            gap: 20px;
            margin: 0;
            min-height: 0; 
        }
        .col-scenario { flex: 2; padding: 0; height: 100%; }
        .col-log { flex: 1; padding: 0; height: 100%; display: flex; flex-direction: column; }

        /* === ì¹´ë“œ ë””ìì¸ === */
        .card { 
            background-color: #141414; 
            border: 1px solid #2a2a2a; 
            border-radius: 8px; 
            height: 100%; 
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6); 
            overflow: hidden;
        }
        .card-header { 
            background-color: #1c1c1c; 
            border-bottom: 1px solid #333; 
            font-weight: 700; color: #ccc; 
            font-size: 1rem; 
            padding: 12px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            flex-shrink: 0;
        }
        .card-body {
            flex: 1; 
            position: relative;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* === ì¹´ë©”ë¼ === */
        .cam-wrapper { 
            position: relative; 
            background: #000; 
            min-height: 360px; 
            display: flex; justify-content: center; align-items: center;
        }
        .cam-feed { width: 100%; height: auto; display: block; }
        .cam-label { 
            position: absolute; top: 15px; left: 15px; 
            background: rgba(0, 0, 0, 0.7); color: #00ffea; 
            padding: 5px 10px; font-size: 0.8rem; font-weight: bold; 
            border-radius: 4px; border: 1px solid rgba(0, 255, 234, 0.4);
            pointer-events: none; 
        }

        /* === ì‹œë‚˜ë¦¬ì˜¤ ë‹¨ê³„ë°” === */
        .scenario-content-wrapper {
            flex: 1; 
            display: flex;
            align-items: center; 
            justify-content: center;
            padding: 0 50px;
        }
        .progress-container { width: 100%; position: relative; }
        .progress-track { position: absolute; top: 35px; left: 0; right: 0; height: 6px; background: #2a2a2a; z-index: 0; border-radius: 3px; }
        .scenario-steps { display: flex; justify-content: space-between; position: relative; z-index: 1; }
        .step-item { text-align: center; width: 18%; opacity: 0.3; transition: all 0.4s ease; }
        .step-circle { width: 70px; height: 70px; margin: 0 auto 15px; background: #1a1a1a; border: 3px solid #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #555; font-weight: 900; transition: all 0.4s ease; }
        .step-label { font-size: 1rem; color: #777; font-weight: 600; letter-spacing: -0.5px; }

        /* í™œì„±/ì™„ë£Œ ë””ìì¸ */
        .active { opacity: 1; transform: scale(1.1); }
        .active .step-circle { background: #0d6efd; border-color: #0d6efd; color: #fff; box-shadow: 0 0 25px rgba(13, 110, 253, 0.5); }
        .active .step-label { color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
        .completed { opacity: 1; } 
        .completed .step-circle { background: #198754; border-color: #198754; color: #fff; } 
        .completed .step-label { color: #198754; }

        .scenario-footer { padding: 20px; border-top: 1px solid #222; background: #111; flex-shrink: 0; }

        /* === ë¡œê·¸ í„°ë¯¸ë„ === */
        .log-terminal { 
            background-color: #080808; 
            color: #ccc; 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 0.95rem; 
            height: 100%; 
            overflow-y: auto; 
            padding: 15px; 
            line-height: 1.6; 
        }
        .log-entry { display: flex; margin-bottom: 5px; border-bottom: 1px solid #1a1a1a; padding-bottom: 2px;}
        .log-time { color: #555; margin-right: 15px; min-width: 80px; font-weight: bold; }
        .log-msg { flex: 1; word-break: break-all; }

        /* [ë¡œë´‡ êµ¬ë¶„ ìƒ‰ìƒ] */
        .log-sys .log-msg { color: #888; font-style: italic; }
        .log-robot-a .log-msg { color: #4dabf7; font-weight: bold; } /* Robot A: íŒŒë‘ */
        .log-robot-b .log-msg { color: #ff922b; font-weight: bold; } /* Robot B: ì£¼í™© */
        .log-emg .log-msg { color: #ff6b6b; font-weight: bold; } /* ì‘ê¸‰ìƒí™©: ë¹¨ê°• */

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-report { border: 1px solid #444; color: #bbb; background: #222; padding: 8px 18px; font-size: 0.9rem; margin-left: 10px; text-decoration: none; display: inline-block; border-radius: 4px; transition: 0.3s; }
        .btn-report:hover { background: #333; color: #fff; border-color: #888; }
        .btn-emergency { background: #5a1a1a; color: #ffadb6; border: 1px solid #842029; width: 100%; font-weight: 800; font-size: 1.2rem; padding: 18px; border-radius: 6px; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        .btn-emergency:hover { background: #b02a37; color: #fff; box-shadow: 0 0 20px rgba(220, 53, 69, 0.6); transform: translateY(-2px); }
        .btn-emergency:active { transform: scale(0.98); }
    </style>
</head>
<body>

<div class="header-bar">
    <div class="d-flex align-items-center">
        <div class="system-title">ì§€í•˜ì²  ì•ˆì „ í†µí•© ê´€ì œ</div>
        <span class="status-indicator">â— SYSTEM ONLINE</span>
    </div>
    <div class="d-flex align-items-center">
        <span style="color:#666; font-size:0.9rem; margin-right: 10px;">OPERATOR:</span>
        <span style="color:#fff; font-weight:bold; margin-right: 25px;">{{ username }}</span>
        
        <a href="/history" class="btn btn-report">ğŸ“Š ìš´í–‰ ì´ë ¥</a>
        <a href="/analytics" class="btn btn-report">ğŸ“„ ìµœì‹  ë³´ê³ ì„œ</a>
        <a href="/logout" class="btn btn-report">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
</div>

<div class="container-fluid main-layout">
    
    <div class="row row-cams">
        <div class="col-cam">
            <div class="card">
                <div class="card-header">
                    <span>CAM 01 : í™˜ì íƒìƒ‰ (Main)</span>
                    <span class="badge bg-success">LIVE</span>
                </div>
                <div class="card-body cam-wrapper">
                    <span class="cam-label">REALTIME FEED</span>
                    <img src="/video/1" class="cam-feed" onclick="sendClick(1, event)" alt="CAM 1 - CONNECTING...">
                </div>
            </div>
        </div>
        <div class="col-cam">
            <div class="card">
                <div class="card-header">
                    <span>CAM 02 : ì£¼ë³€ ìƒí™© (Sub)</span>
                    <span class="badge bg-success">LIVE</span>
                </div>
                <div class="card-body cam-wrapper">
                    <span class="cam-label">REALTIME FEED</span>
                    <img src="/video/2" class="cam-feed" onclick="sendClick(2, event)" alt="CAM 2 - CONNECTING...">
                </div>
            </div>
        </div>
    </div>

    <div class="row row-info">
        
        <div class="col-scenario">
            <div class="card">
                <div class="card-header">
                    <span>ì‹¬ì •ì§€ ëŒ€ì‘ ì‹œë‚˜ë¦¬ì˜¤ ì§„í–‰ìƒí™©</span>
                </div>
                
                <div class="card-body">
                    <div class="scenario-content-wrapper">
                        <div class="progress-container">
                            <div class="progress-track"></div>
                            <div class="scenario-steps">
                                <div class="step-item active" id="step-1">
                                    <div class="step-circle">1</div>
                                    <div class="step-label">ìƒí™© ì ‘ìˆ˜</div>
                                </div>
                                <div class="step-item" id="step-2">
                                    <div class="step-circle">2</div>
                                    <div class="step-label">ìœ ë‹› ì¶œë™</div>
                                </div>
                                <div class="step-item" id="step-3">
                                    <div class="step-circle">3</div>
                                    <div class="step-label">í™˜ì ë°œê²¬</div>
                                </div>
                                <div class="step-item" id="step-4">
                                    <div class="step-circle">4</div>
                                    <div class="step-label">êµ¬ê¸‰ëŒ€ ì§„ì…</div>
                                </div>
                                <div class="step-item" id="step-5">
                                    <div class="step-circle">5</div>
                                    <div class="step-label">ìƒí™© ì¢…ë£Œ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="scenario-footer">
                        <button class="btn btn-emergency" onclick="stopTask()">
                            âš  ë¹„ìƒ ì •ì§€ (EMERGENCY STOP)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-log">
            <div class="card">
                <div class="card-header">
                    <span>ì‹¤ì‹œê°„ ì‹œìŠ¤í…œ ë¡œê·¸</span>
                </div>
                <div class="card-body p-0">
                    <div class="log-terminal" id="sys-logs">
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ì„¸ì…˜ ì‹œì‘ ì‹œê°„ (ë¡œê·¸ í•„í„°ë§ìš©)
    let sessionStartTime = sessionStorage.getItem('controlSessionStart');
    if (!sessionStartTime) {
        sessionStartTime = new Date().getTime();
        sessionStorage.setItem('controlSessionStart', sessionStartTime);
    }

    // í™”ë©´ ë¡œë“œ ì‹œ ì´ˆê¸° ë©”ì‹œì§€
    window.onload = function() {
        const box = document.getElementById('sys-logs');
        if (!box.innerHTML.trim()) {
            const now = new Date();
            const timeStr = now.toTimeString().split(' ')[0];
            box.innerHTML = `<div class="log-entry log-sys"><span class="log-time">${timeStr}</span><span class="log-msg">ì‹œìŠ¤í…œ ê°€ë™ ì‹œì‘... ë¡œë´‡ ìœ ë‹› ëŒ€ê¸° ì¤‘.</span></div>`;
        }
    };

    // 1ì´ˆë§ˆë‹¤ ìƒíƒœ ì—…ë°ì´íŠ¸ ìš”ì²­
    setInterval(updateStatus, 1000);

    function updateStatus() { 
        fetch('/api/status').then(res => res.json()).then(data => { 
            // 1. ë¹„í™œì„± ìƒíƒœë©´ ë¬´ì¡°ê±´ 1ë‹¨ê³„ë¡œ ì´ˆê¸°í™”
            if (data.is_active === false) { 
                updateStepUI(1); 
            } else { 
                // í™œì„± ìƒíƒœë©´ ë¡œê·¸ ë¶„ì„í•´ì„œ ë‹¨ê³„ ê²°ì •
                analyzeScenarioStage(data.logs.emergency); 
            }
            // 2. ë¡œê·¸ì°½ ì—…ë°ì´íŠ¸
            updateLogConsole(data.logs.emergency, data.logs.system); 
        }); 
    }

    // [ì‹œë‚˜ë¦¬ì˜¤ ë‹¨ê³„ ìë™ ì¸ì‹]
    function analyzeScenarioStage(logs) {
        if(!logs || logs.length === 0) { updateStepUI(1); return; }

        const latestLog = logs[0][1]; // APIê°€ desc ì •ë ¬ë¡œ ì¤„ ê²½ìš° 0ë²ˆì´ ìµœì‹ 
    
        // í•µì‹¬ ìˆ˜ì •: ë©”ì‹œì§€ì— "ëŒ€ê¸°"ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ 1ë‹¨ê³„
        if (latestLog.includes("ë¡œë´‡ ëŒ€ê¸°") || latestLog.includes("ìƒí™© ì ‘ìˆ˜")) {
            updateStepUI(1);
            return;
        }

        
    

        let currentStage = 1;
        if (latestLog.includes("ë³µê·€") || latestLog.includes("ìƒí™© ì¢…ë£Œ")) currentStage = 5;
        else if (latestLog.includes("í•¨ê»˜") || latestLog.includes("ì¸ê³„")) currentStage = 4;
        else if (latestLog.includes("í†µì œ") || latestLog.includes("ë°œê²¬")) currentStage = 3; // 'ìŠ¹ê° í†µì œ'ëŠ” ì—¬ê¸°!
        else if (latestLog.includes("AED") || latestLog.includes("ì´ì†¡") || latestLog.includes("ì¶œë™")) currentStage = 2;

        updateStepUI(currentStage);
    }

    // [UI ì—…ë°ì´íŠ¸] ë‹¨ê³„ë°” ë¶ˆ ì¼œê¸°/ë„ê¸°
    function updateStepUI(stage) {
        for(let i=1; i<=5; i++) {
            const el = document.getElementById(`step-${i}`);
            el.classList.remove('active', 'completed');
            
            if(i < stage) { 
                // ì§€ë‚˜ê°„ ë‹¨ê³„
                el.classList.add('completed'); 
                el.querySelector('.step-circle').innerHTML = 'âœ”'; 
            } else if (i === stage) { 
                // í˜„ì¬ ë‹¨ê³„ (ë¶ˆ ì¼œì§)
                el.classList.add('active'); 
                el.querySelector('.step-circle').innerText = i; 
            } else { 
                // ë¯¸ë˜ ë‹¨ê³„ (êº¼ì§)
                el.querySelector('.step-circle').innerText = i; 
            }
        }
    }

    // [ë¡œê·¸ ì¤‘ë³µ ì œê±° ë° ì¶œë ¥] í•µì‹¬ ë¡œì§
    function updateLogConsole(emerLogs, sysLogs) {
        const box = document.getElementById('sys-logs');
        let allLogs = [];

        // ë°ì´í„° ì •ì œ (ì‘ê¸‰ ë¡œê·¸)
        if (emerLogs) {
            emerLogs.slice(0, 50).forEach(log => {
                let raw = log[1];
                let timeStr = "";
                let msg = raw;
                let sortTime = 0;
                try {
                    const match = raw.match(/\[(.*?)\]/);
                    if(match) {
                        timeStr = match[1].split(' ')[1]; 
                        msg = raw.substring(match[0].length).trim();
                        sortTime = new Date(match[1]).getTime();
                    }
                } catch(e) {}
                if(sortTime) allLogs.push({ raw: log[1], time: timeStr.split('.')[0], msg: msg, st: sortTime });
            });
        }
        // ë°ì´í„° ì •ì œ (ì‹œìŠ¤í…œ ë¡œê·¸)
        if (sysLogs) {
            sysLogs.slice(0, 20).forEach(log => {
                let timeStr = log[2].split(' ')[1];
                allLogs.push({ raw: log[1], time: timeStr.split('.')[0], msg: "[SYSTEM] " + log[1], st: new Date(log[2]).getTime() });
            });
        }

        // ìµœì‹ ìˆœ ì •ë ¬
        allLogs.sort((a, b) => b.st - a.st);

        let html = '';
        
        // í† í”½ë³„ ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì¶”ì  (ì¤‘ë³µ ë°©ì§€ìš©)
        let lastMsgByTopic = { 'RobotA': '', 'RobotB': '', 'EMG': '', 'SYS': '' };

        // ê³¼ê±° -> ìµœì‹  ìˆœìœ¼ë¡œ ìˆœíšŒí•˜ë©° ì¤‘ë³µ ê²€ì‚¬ (í™”ë©´ í‘œì‹œëŠ” ì—­ìˆœì´ë¯€ë¡œ ë°°ì—´ ë’¤ì§‘ì–´ì„œ ì²˜ë¦¬)
        let chronoLogs = [...allLogs].reverse(); 
        let filteredLogs = [];

        chronoLogs.forEach(item => {
            if (item.st < sessionStartTime) return;

            // í† í”½ íŒë³„
            let topic = 'SYS';
            let className = 'log-sys';
            if (item.raw.includes("Robot A")) { topic = 'RobotA'; className = 'log-robot-a'; }
            else if (item.raw.includes("Robot B")) { topic = 'RobotB'; className = 'log-robot-b'; }
            else if (item.raw.includes("ì‘ê¸‰") || item.raw.includes("êµ¬ê¸‰ëŒ€")) { topic = 'EMG'; className = 'log-emg'; }

            // [ì¤‘ë³µ í•„í„°ë§] ì§ì „ ë©”ì‹œì§€ì™€ ê°™ìœ¼ë©´ ë¬´ì‹œ
            if (lastMsgByTopic[topic] === item.msg) return; 

            // ìƒˆ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            lastMsgByTopic[topic] = item.msg;
            
            // ê²°ê³¼ ë°°ì—´ ì•ìª½ì— ì¶”ê°€ (ìµœì‹ ì´ ìœ„ë¡œ ì˜¤ë„ë¡)
            filteredLogs.unshift({ ...item, className: className });
        });

        // HTML ì¡°ë¦½
        filteredLogs.forEach(item => {
            html += `<div class="log-entry ${item.className}"><span class="log-time">${item.time}</span><span class="log-msg">${item.msg}</span></div>`;
        });

        if (html && box.innerHTML !== html) {
            box.innerHTML = html;
        }
    }

    function sendClick(camId, event) {
        const width = 1280, height = 720;
        const rect = event.target.getBoundingClientRect();
        const x = (event.clientX - rect.left) * (width / rect.width);
        const y = (event.clientY - rect.top) * (height / rect.height);
        
        fetch('/api/click', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: camId, x: Math.round(x), y: Math.round(y)})
        });
    }

    function stopTask() {
        fetch('/api/task_end', {method: 'POST'});
        console.log("Emergency Stop Signal Sent.");
    }
</script>
</body>
</html>