<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€í•˜ì²  ìŠ¤ë§ˆíŠ¸ ì•ˆì „ ê´€ì œ | Smart Safety Control</title>
    <style>
        /* [1] ì „ì²´ ë ˆì´ì•„ì›ƒ (í™”ë©´ í¬ê¸° ê³ ì •, ìŠ¤í¬ë¡¤ ë°©ì§€) */
        body { 
            background-color: #121212; 
            color: #e0e0e0; 
            font-family: 'Pretendard', sans-serif; 
            margin: 0; 
            padding: 15px; 
            height: 100vh; 
            box-sizing: border-box;
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* [2] ìƒë‹¨ í—¤ë” */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 3px solid #ff9800; 
            padding-bottom: 15px; 
            margin-bottom: 15px; 
            flex-shrink: 0; 
        }
        .header h1 { margin: 0; font-size: 24px; color: #fff; letter-spacing: 0.5px; } 
        .header h1 span { color: #ff9800; } 
        
        .user-info { font-size: 14px; color: #aaa; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ë¡œê·¸ì•„ì›ƒ, ë¶„ì„ ë“±) */
        .btn-link {
            text-decoration: none; 
            padding: 8px 16px; 
            border-radius: 4px; 
            font-weight: bold; 
            margin-left: 10px;
            font-size: 14px;
            transition: 0.3s;
            display: inline-block;
        }
        .btn-analytics { background: #2196F3; color: white; }
        .btn-analytics:hover { background: #1976D2; }
        .btn-logout { background: #d32f2f; color: white; }
        .btn-logout:hover { background: #b71c1c; }

        /* [3] ì˜ìƒ ëª¨ë‹ˆí„°ë§ ì˜ì—­ (2ë¶„í• ) */
        .video-container { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            margin-bottom: 15px; 
            flex: 1; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
            min-height: 0; /* ë„˜ì¹¨ ë°©ì§€ */
        }
        
        .panel { 
            background: #1e1e1e; 
            padding: 10px; 
            border-radius: 8px; 
            border: 1px solid #333; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }
        
        .panel-title { 
            font-size: 16px; 
            font-weight: bold; 
            margin-bottom: 8px; 
            color: #e0e0e0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-shrink: 0; 
        }
        
        /* [ì¤‘ìš”] ì¹´ë©”ë¼ ìƒíƒœ ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .badge { 
            padding: 2px 8px; 
            font-size: 11px; 
            border-radius: 3px; 
            font-weight: bold; 
            text-transform: uppercase;
        }
        .badge-live { 
            background: #d32f2f; 
            color: white; 
            animation: blink 2s infinite; 
        }
        .badge-offline { 
            background: #555; 
            color: #aaa; 
            border: 1px solid #777;
        }
        @keyframes blink { 50% { opacity: 0.5; } }

        .video-box { 
            width: 100%;      
            aspect-ratio: 16 / 9;    
            background: #000; 
            border-radius: 4px; 
            overflow: hidden; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 1px solid #444; 
            position: relative; 
            margin: 0 auto;   
        }

        .video-box img { 
            width: 100%; 
            height: 100%; 
            object-fit: fill;    
            cursor: crosshair; 
            display: block;        /* í•˜ë‹¨ ë¯¸ì„¸í•œ ì—¬ë°± ì œê±° */
        }

        .cam-overlay { 
            position: absolute; 
            top: 10px; left: 10px; 
            background: rgba(0,0,0,0.6); 
            color: #00e676; 
            padding: 4px 8px; 
            font-size: 12px; 
            border-radius: 4px; 
        }

        /* [4] í•˜ë‹¨ ì •ë³´ ì˜ì—­ (ì¢Œ: ë¡œë´‡ìƒíƒœ, ìš°: ë¡œê·¸) */
        .bottom-container { 
            display: grid; 
            grid-template-columns: 2.5fr 1fr; 
            gap: 15px; 
            height: 35%; /* ë†’ì´ ê³ ì • */
            min-height: 0; 
        }

        /* ì¢Œì¸¡ ë¡œë´‡ íŒ¨ë„ */
        .status-panel { 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }
        .status-content { 
            overflow: auto; 
            flex: 1; 
        }
        
        table { width: 100%; border-collapse: collapse; text-align: center; font-size: 14px; }
        th { background: #2c2c2c; padding: 10px; color: #ff9800; border-bottom: 2px solid #444; position: sticky; top:0; }
        td { padding: 10px; border-bottom: 1px solid #333; vertical-align: middle; }
        
        /* [NEW] ì‘ì—… ì¢…ë£Œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-end-task { 
            width: 100%; margin-top: 10px; 
            background: #ff5722; color: white; 
            padding: 12px; font-size: 15px; font-weight: bold; 
            border: none; border-radius: 4px; cursor: pointer; transition: 0.3s;
            flex-shrink: 0;
        }
        .btn-end-task:hover { background: #e64a19; }

        /* ìš°ì¸¡ ë¡œê·¸ íŒ¨ë„ */
        .log-container { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            height: 100%; 
            min-height: 0; 
        }
        .log-box { 
            flex: 1; 
            background: #1a1a1a; 
            border: 1px solid #333; 
            border-radius: 6px; 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            min-height: 0; 
        }
        .log-title { 
            font-size: 13px; 
            font-weight: bold; 
            margin-bottom: 5px; 
            border-bottom: 1px solid #444; 
            padding-bottom: 4px; 
            flex-shrink: 0; 
        }
        .log-content { 
            flex: 1; 
            overflow-y: auto; 
            font-size: 12px; 
            color: #bbb; 
            font-family: 'Consolas', monospace; 
            padding-right: 5px; 
        }
        .log-item { display: flex; border-bottom: 1px solid #2a2a2a; padding: 2px 0; align-items: center; }
        .time-stamp { color: #ff9800; margin-right: 8px; font-weight: bold; min-width: 70px; font-size: 11px; }
        .log-msg { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #eee; }

    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸš‡ ì§€í•˜ì²  ìŠ¤ë§ˆíŠ¸ <span>ì•ˆì „ ê´€ì œ ì‹œìŠ¤í…œ</span></h1>
        <div class="user-info">
            ì•ˆì „ê´€ë¦¬ì: <strong>{{ username }}</strong>
            <a href="/analytics" class="btn-link btn-analytics">ğŸ“Š ë°ì´í„° ë¶„ì„</a>
            <a href="/logout" class="btn-link btn-logout">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>

    <div class="video-container">
        <div class="panel">
            <div class="panel-title">
                <span>ğŸ“· CAM 1 : ìŠ¹ê°•ì¥ ì•ˆì „ êµ¬ì—­ (Robot 3)</span>
                <span id="badge-cam1" class="badge badge-offline">CONNECTING...</span>
            </div>
            <div class="video-box">
                <div class="cam-overlay">REC â—</div>
                <img id="cam1-view" src="/video/1">
            </div>
        </div>
        <div class="panel">
            <div class="panel-title">
                <span>ğŸ“· CAM 2 : ê³„ë‹¨ ì§„ì…ë¡œ (Robot 5)</span>
                <span id="badge-cam2" class="badge badge-offline">CONNECTING...</span>
            </div>
            <div class="video-box">
                <div class="cam-overlay">REC â—</div>
                <img id="cam2-view" src="/video/2">
            </div>
        </div>
    </div>

    <div class="bottom-container">
        
        <div class="panel status-panel">
            <div class="panel-title">âš™ï¸ ì•ˆì „ ìˆœì°° ë¡œë´‡ ìš´ìš© í˜„í™©</div>
            <div class="status-content">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th><th>ë°°í„°ë¦¬</th><th>ìœ„ì¹˜ (X, Y)</th><th>ìš´ìš© ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="color:#4dabf7; font-weight:bold;">ROBOT 3</td>
                            <td id="r3-bat">--%</td>
                            <td id="r3-pos">-,-</td>
                            <td id="r3-stat">ì—°ê²°ì¤‘</td>
                        </tr>
                        <tr>
                            <td style="color:#ff6b6b; font-weight:bold;">ROBOT 5</td>
                            <td id="r5-bat">--%</td>
                            <td id="r5-pos">-,-</td>
                            <td id="r5-stat">ì—°ê²°ì¤‘</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button class="btn-end-task" onclick="sendTaskEnd()">ğŸš¨ ì‘ì—… ì¢…ë£Œ ë° ë³µê·€ (END TASK)</button>
            <div style="padding:15px; text-align:center; color:#777; font-size:12px;">
                ğŸ’¡ í™”ë©´ì˜ ëª©í‘œ ì§€ì ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ë¡œë´‡ì—ê²Œ ì¶œë™ ëª…ë ¹ì„ ì „ì†¡í•©ë‹ˆë‹¤.
            </div>
        </div>

        <div class="log-container">
            <div class="log-box" style="border-top: 3px solid #d32f2f;">
                <div class="log-title" style="color:#ff8a80;">ğŸš¨ ì•ˆì „ ì‚¬ê³  / ì‘ê¸‰ ì•Œë¦¼</div>
                <div class="log-content" id="emer-logs"></div>
            </div>
            <div class="log-box" style="border-top: 3px solid #2e7d32;">
                <div class="log-title" style="color:#a5d6a7;">ğŸ’¾ ì‹œìŠ¤í…œ ì œì–´ ì´ë ¥</div>
                <div class="log-content" id="sys-logs"></div>
            </div>
        </div>

    </div>

    <script>
        // 1ì´ˆë§ˆë‹¤ ë°±ì—”ë“œ ìƒíƒœ ì¡°íšŒ
        setInterval(() => { 
            fetch('/api/status').then(r=>r.json()).then(d => { 
                updateRobot('r3', d.robots.robot3); 
                updateRobot('r5', d.robots.robot5); 
                renderLogs('emer-logs', d.logs.emergency); 
                renderLogs('sys-logs', d.logs.system);
                
                // ì¹´ë©”ë¼ ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
                updateCamBadge('badge-cam1', d.cam_status['1']);
                updateCamBadge('badge-cam2', d.cam_status['2']);
            }); 
        }, 1000);

        // ì¹´ë©”ë¼ ë°°ì§€ ë³€ê²½ í•¨ìˆ˜
        function updateCamBadge(elementId, isLive) {
            const el = document.getElementById(elementId);
            if (isLive) {
                el.innerText = "LIVE";
                el.className = "badge badge-live";
            } else {
                el.innerText = "OFFLINE";
                el.className = "badge badge-offline";
            }
        }

        // ë¡œë´‡ ìƒíƒœ í‘œì‹œ í•¨ìˆ˜
        function updateRobot(p, i) { 
            if(i.bat == -1){
                document.getElementById(p+'-bat').innerText = "í™•ì¸ë¶ˆê°€"; 
                document.getElementById(p+'-bat').style.color = "#888";
            } else {
                document.getElementById(p+'-bat').innerText = i.bat + '%'; 
                document.getElementById(p+'-bat').style.color = i.bat < 20 ? "#ff5252" : "#e0e0e0";
            }
            document.getElementById(p+'-pos').innerText = i.x + ', ' + i.y; 
            document.getElementById(p+'-stat').innerText = i.status;
            
            const s = document.getElementById(p+'-stat'); 
            if(i.status.includes("ì´ë™") || i.status.includes("ì‘ì—…")) s.style.color = "#69f0ae"; 
            else s.style.color = "#e0e0e0";
        }

        // ë¡œê·¸ ë Œë”ë§ í•¨ìˆ˜
        function renderLogs(id, logs) { 
            const container = document.getElementById(id);
            container.innerHTML = logs.map(l => {
                const timePart = l[2].split(' ')[1].split('.')[0];
                return `<div class="log-item">
                            <span class="time-stamp">[${timePart}]</span>
                            <span class="log-msg">${l[1]}</span>
                        </div>`;
            }).join(''); 
        }

        // ì‘ì—… ì¢…ë£Œ ë²„íŠ¼ í•¸ë“¤ëŸ¬
        function sendTaskEnd() {
            if(confirm("ì •ë§ë¡œ ëª¨ë“  ì‘ì—…ì„ ì¢…ë£Œí•˜ê³  ë¡œë´‡ì„ ë³µê·€ì‹œí‚¤ê² ìŠµë‹ˆê¹Œ?")) {
                fetch('/api/task_end', { method: 'POST' })
                .then(res => res.json())
                .then(data => alert("âœ… ì‘ì—… ì¢…ë£Œ ëª…ë ¹ì„ ì „ì†¡í–ˆìŠµë‹ˆë‹¤. ë¡œë´‡ì´ ë³µê·€í•©ë‹ˆë‹¤."));
            }
        }

        // í´ë¦­ ì¢Œí‘œ ì „ì†¡ í•¨ìˆ˜ (ì œì–´ ëª…ë ¹)
        // í´ë¦­ ì¢Œí‘œ ì „ì†¡ í•¨ìˆ˜ (ë¹„ìœ¨ ë³´ì • ì¶”ê°€)
        function setupClick(elementId, camId) { 
            const imgEl = document.getElementById(elementId);
            
            imgEl.addEventListener('click', e => { 
                // 1. í˜„ì¬ í™”ë©´ì— í‘œì‹œëœ ì´ë¯¸ì§€ì˜ í¬ê¸°ì™€ ìœ„ì¹˜
                const rect = e.target.getBoundingClientRect(); 
                
                // 2. í´ë¦­í•œ ìœ„ì¹˜ (í™”ë©´ ê¸°ì¤€ í”½ì…€)
                const clientX = e.clientX - rect.left;
                const clientY = e.clientY - rect.top;

                // 3. ë¹„ìœ¨ ê³„ì‚° (ì›ë³¸ í•´ìƒë„ 1280x720 ê¸°ì¤€)
                // naturalWidthê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ê¸°ë³¸ê°’ 1280 ì„¤ì •
                const originalW = imgEl.naturalWidth || 1280;
                const originalH = imgEl.naturalHeight || 720;
                
                const scaleX = originalW / rect.width;
                const scaleY = originalH / rect.height;

                // 4. ì‹¤ì œ ì „ì†¡í•  ì¢Œí‘œ ê³„ì‚°
                const realX = Math.round(clientX * scaleX);
                const realY = Math.round(clientY * scaleY);
                
                console.log(`[CLICK] í™”ë©´ì¢Œí‘œ:(${clientX},${clientY}) -> ì›ë³¸ë³€í™˜:(${realX},${realY})`);

                // 5. ì„œë²„ ì „ì†¡
                fetch('/api/click', {
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({id: camId, x: realX, y: realY})
                }); 
            }); 
        }

        // í•¨ìˆ˜ í˜¸ì¶œ
        setupClick('cam1-view', 1); 
        setupClick('cam2-view', 2);
    </script>
</body>
</html>