<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œìŠ¤í…œ ë°ì´í„° ë¶„ì„ | Analytics</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* [1] ì „ì²´ ë ˆì´ì•„ì›ƒ & ë‹¤í¬ í…Œë§ˆ */
        body { 
            background-color: #121212; 
            color: #e0e0e0; 
            font-family: 'Pretendard', sans-serif; 
            margin: 0; 
            padding: 20px; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            box-sizing: border-box; 
        }
        
        /* [2] í—¤ë” ìŠ¤íƒ€ì¼ */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 3px solid #2196F3; /* ë¶„ì„ í…Œë§ˆ ì»¬ëŸ¬ (íŒŒë‘) */
            padding-bottom: 15px; 
            margin-bottom: 20px; 
            flex-shrink: 0;
        }
        .header h1 { margin: 0; color: white; font-size: 24px; } 
        .header h1 span { color: #2196F3; }
        
        /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
        .btn-back { 
            background: #444; 
            color: white; 
            text-decoration: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            font-weight: bold; 
            transition: 0.3s; 
            font-size: 14px;
        }
        .btn-back:hover { background: #666; }

        /* [3] ì°¨íŠ¸ ë ˆì´ì•„ì›ƒ (Grid) */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: 1fr 2fr; /* 1:2 ë¹„ìœ¨ */
            gap: 20px; 
            height: 45%; 
            margin-bottom: 20px; 
            min-height: 0;
        }
        
        /* ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .card { 
            background: #1e1e1e; 
            border: 1px solid #333; 
            border-radius: 10px; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .card-title { 
            font-weight: bold; 
            margin-bottom: 15px; 
            color: #90caf9; 
            font-size: 16px; 
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        
        /* ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ (ë°˜ì‘í˜• ì°¨íŠ¸ í•„ìˆ˜) */
        .chart-box { 
            flex: 1; 
            position: relative; 
            width: 100%; 
            height: 100%; 
            min-height: 0;
        }

        /* [4] í•˜ë‹¨ í…Œì´ë¸” ì˜ì—­ */
        .table-container { 
            flex: 1; 
            background: #1e1e1e; 
            border: 1px solid #333; 
            border-radius: 10px; 
            padding: 15px; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            min-height: 0;
        }
        
        .table-wrapper { 
            overflow-y: auto; 
            flex: 1; 
            margin-top: 5px;
        }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; text-align: left; }
        
        th { 
            background: #2c2c2c; 
            padding: 12px; 
            color: #2196F3; 
            position: sticky; 
            top: 0; 
            z-index: 10;
            font-weight: bold;
        }
        
        td { 
            padding: 10px; 
            border-bottom: 1px solid #333; 
            color: #ccc; 
            font-size: 13px; 
        }
        
        tr:hover { background: #252525; transition: 0.2s; }
        
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }

    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸ“Š ì‹œìŠ¤í…œ <span>ë°ì´í„° ë¶„ì„ì‹¤ (Analytics)</span></h1>
        <a href="/dashboard" class="btn-back">ğŸ”™ ê´€ì œ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <div class="card-title">ğŸ¤– ë¡œë´‡ë³„ ì‘ì—… ì ìœ ìœ¨ (Work Share)</div>
            <div class="chart-box">
                <canvas id="robotPieChart"></canvas>
            </div>
        </div>
        <div class="card">
            <div class="card-title">ğŸ“ˆ ì‹œê°„ëŒ€ë³„ ì‹œìŠ¤í…œ í™œë™ëŸ‰ (Hourly Traffic)</div>
            <div class="chart-box">
                <canvas id="timeLineChart"></canvas>
            </div>
        </div>
    </div>

    <div class="table-container">
        <div class="card-title">ğŸ“ ìƒì„¸ ë¡œê·¸ ë°ì´í„°ë² ì´ìŠ¤ (ìµœì‹  100ê±´)</div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th style="width: 10%;">ID</th>
                        <th style="width: 25%;">ë°œìƒ ì‹œê°„ (Timestamp)</th>
                        <th>ë¡œê·¸ ë‚´ìš© (Event Message)</th>
                    </tr>
                </thead>
                <tbody id="log-table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // ì°¨íŠ¸ ê°ì²´ë¥¼ ì €ì¥í•  ë³€ìˆ˜ (ê°±ì‹  ì‹œ ì‚­ì œ í›„ ì¬ìƒì„±ì„ ìœ„í•´ í•„ìš”)
        let pieChart = null;
        let lineChart = null;

        // API ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        async function fetchData() {
            try {
                const res = await fetch('/api/analytics/data');
                const data = await res.json();
                
                updateCharts(data);
                updateTable(data.logs);
            } catch (error) {
                console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
            }
        }

        // ì°¨íŠ¸ ê·¸ë¦¬ê¸°/ê°±ì‹  í•¨ìˆ˜
        function updateCharts(data) {
            // --- 1. íŒŒì´ ì°¨íŠ¸ (ë¡œë´‡ ì ìœ ìœ¨) ---
            const ctxPie = document.getElementById('robotPieChart').getContext('2d');
            
            // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ (ì¤‘ë³µ ë Œë”ë§ ë°©ì§€)
            if (pieChart) pieChart.destroy();
            
            pieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['ROBOT 3 (Blue)', 'ROBOT 5 (Red)'],
                    datasets: [{
                        data: data.pie_data, // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° [r3_count, r5_count]
                        backgroundColor: ['#4dabf7', '#ff6b6b'], // íŒŒë‘, ë¹¨ê°•
                        borderColor: '#1e1e1e',
                        borderWidth: 2
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'bottom', labels: { color: '#e0e0e0', font: { size: 12 } } } 
                    } 
                }
            });

            // --- 2. ë¼ì¸ ì°¨íŠ¸ (ì‹œê°„ëŒ€ë³„ í™œë™) ---
            const ctxLine = document.getElementById('timeLineChart').getContext('2d');
            
            if (lineChart) lineChart.destroy();

            lineChart = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: data.line_data.labels, // ì‹œê°„ëŒ€ ë¼ë²¨ (14ì‹œ, 15ì‹œ...)
                    datasets: [{
                        label: 'ì´ë²¤íŠ¸ ë°œìƒ ìˆ˜',
                        data: data.line_data.values, // ë°œìƒ íšŸìˆ˜ ë°ì´í„°
                        borderColor: '#00e676', // ì´ˆë¡ìƒ‰ ë¼ì¸
                        backgroundColor: 'rgba(0, 230, 118, 0.1)', // ë¼ì¸ ì•„ë˜ ì±„ìš°ê¸° ìƒ‰
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4, // ë¶€ë“œëŸ¬ìš´ ê³¡ì„ 
                        pointBackgroundColor: '#fff',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            ticks: { color: '#bbb' }, 
                            grid: { color: '#333' } 
                        },
                        y: { 
                            ticks: { color: '#bbb', beginAtZero: true, stepSize: 1 }, 
                            grid: { color: '#333' } 
                        }
                    },
                    plugins: { 
                        legend: { labels: { color: '#e0e0e0' } } 
                    }
                }
            });
        }

        // í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateTable(logs) {
            const tbody = document.getElementById('log-table-body');
            // map í•¨ìˆ˜ë¡œ HTML ë¬¸ìì—´ ìƒì„± í›„ ì‚½ì…
            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td>${log[0]}</td>
                    <td style="color:#ffb74d; font-family: monospace;">${log[2]}</td>
                    <td>${log[1]}</td>
                </tr>
            `).join('');
        }

        // ì´ˆê¸° ì‹¤í–‰ ë° 3ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
        fetchData();
        setInterval(fetchData, 3000);
    </script>
</body>
</html>